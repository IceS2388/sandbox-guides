<style type="text/css" media="screen">
@import url("https://cloudfront-files-1.publicintegrity.org/offshoreleaks/neo4j/guide/styles/panama_guide.css");
</style>
<article class="guide" ng-controller="AdLibDataController">
  <carousel class="deck container-fluid panama-deck">

<slide class="row-fluid">
  <div class="row">
    <div class="col-sm-12">
      <h3>Querying the Data</h3>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 visible-sm visible-xs">
      <img class="img-responsive img-thumbnail" src="https://cloudfront-files-1.publicintegrity.org/offshoreleaks/neo4j/guide/img/investigating_half.jpg" alt="investigating">
    </div>
    <div class="clearfix visible-sm visible-xs">
      <p>&nbsp;</p>
    </div>
    <div class="col-lg-6">
      <div class="paragraph">
        <p>This interactive guide will help you explore the Panama Papers and the Offshore Leaks data using Cypher, Neo4j&#8217;s graph query language.</p>
      </div>
      <div class="paragraph">
        <p>You&#8217;ll have the same investigative power we had in order to discover additional stories
          behind the data.</p>
      </div>
      <div class="paragraph">
        <p>Be sure to read the  <a play-topic=" https://guides.neo4j.com/sandbox/icij-panama-papers/datashape.html">shape of the data section</a>  to understand the basics of Cypher and the data model used in the graph database.</p>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="paragraph">
        <p>This guide covers:</p>
      </div>
      <div class="ulist">
        <ul>
        <li>
        <p>Statistics</p>
        </li>
        <li>
        <p>Visual vs Tabular Results</p>
        </li>
        <li>
        <p>Investigating invidual people and entities</p>
        </li>
        <li>
        <p>Finding x-degree relationships</p>
        </li>
        <li>
        <p>Finding shortest paths and connections between entities</p>
        </li>
        <li>
        <p>Frequently recurring pairs</p>
        </li>
        </ul>
      </div>
    </div>
	</div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Overview</h3>
    <br/>
    <div>



   <h4>Let’s see what data is in this database.</h4>
   <div class="paragraph">
<p>Run the embedded query to examine graph structure that we have just created.
We see nodes for each type of entity, connected by the relationships they have. For a large graph we should sample 1000 nodes of each label to find relationships.</p>
</div>
<div class="listingblock">
<div class="title">Meta Graph</div>
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">CALL apoc.meta.graphSample(1000)</code></pre>
<div class="paragraph">
          <p>To execute this query, please <strong>click</strong> on the statement above to put the query in the query editor above. <br/>Hit the triangular <span class="icon"><i class="fa fa-play-circle"></i></span> button or press <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>Enter</kbd></span> to <strong>run it</strong> and see the resulting visualization.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We can also check how many entities of each type are in our database.</p>
</div>
<div class="listingblock">
<div class="title">Counts per entity type</div>
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (node)
RETURN labels(node) AS type,count(*)</code></pre>

</div>
</div>



   <h4>Which intermediaries have the most connections to which entities</h4>
   <div class="listingblock">
    <div class="content">
    <pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (i:Intermediary) WHERE size( (i)--() ) &gt; 100
MATCH (i)-[connection]-(entity)
RETURN i.name as intermediary, type(connection) as relationship, head(labels(entity)) as type, count(*) as count
ORDER BY count DESC LIMIT 20</code></pre>
    </div>
  </div>
	</div>
      <div class="paragraph">
      <p>Click on the block to put the query in the top most window on the query editor. Hit the triangular <span class="icon"><i class="fa fa-play-circle"></i></span> button or press <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>Enter</kbd></span> to run it and see the resulting visualization.</p>
      </div>
  </div>

<h4>Filter datasource</h4>
<div class="paragraph">
<p>Note that the above query is searching both offshore leaks and panama papers datasets. To filter for just one source, use a <code>WHERE</code> clause. For example:
</div>
   <div class="listingblock">
    <div class="content">
    <pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (i:Intermediary) WHERE i.sourceID = "Panama Papers" AND size( (i)--() ) &gt; 100
MATCH (i)-[connection]-(entity)
RETURN i.name as intermediary, type(connection) as relationship, head(labels(entity)) as type, count(*) as count
ORDER BY count DESC LIMIT 20</code></pre>
    </div>
  </div>
  </div>
  </div>


</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Query for visual results</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>Querying the graph with Cypher is all about graph pattern matching. To query the graph we define graph patterns to be searched. For example, we can define the pattern "Intermediary connected to an Entity node through the INTERMEDIARY_OF relationship" as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(i:Intermediary)-[r:INTERMEDIARY_OF]-&gt;(e:Entity)</pre>
</div>
</div>
<div class="paragraph">
<p>We use variables <code>i</code>, <code>e</code> and <code>r</code> respectively for later filtering with <code>WHERE</code> and <code>RETURN</code>ing results, these are aliases that can be reused within a single Cypher statement.</p>
</div>
<div class="listingblock">
<div class="title">Entities registered by an Intermediary</div>
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (i:Intermediary)-[r:INTERMEDIARY_OF]-&gt;(e:Entity)
WHERE i.name CONTAINS "MOSSACK" and e.jurisdiction = "SEY"
RETURN i, r, e LIMIT 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>The results of this query are visualized as a graph, you can switch between the graph visualization and tabular results with the icons on the left side of the results view.</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Query for tabular results</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>Let's query for the pattern "Officer node connected to an Entity node through BENEFICIARY_OF relationship":</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(o:Officer)-[:BENEFICIARY_OF]-&gt;(:Entity)</pre>
</div>
</div>
<div class="paragraph">
<p>We then <code>count</code> the entities per officer in an <strong>aggregation</strong> and <code>ORDER BY</code> that count `DESC`ending and return the top-10 results.</p>
</div>
<div class="listingblock">
<div class="title">Officers with most entities</div>
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (o:Officer)-[:BENEFICIARY_OF]-&gt;(:Entity)
RETURN o.name, count(*) as entities
ORDER BY entities DESC LIMIT 10</code></pre>
</div>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Search for Officer nodes by name</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>Enter any name into the form then click on the query to execute to see if that person appears in the data. Note that this search is case sensitive and searches exact matches only.</p>
</div>
<form><div class="node"><div class="form-group">
<label>Name of officer:</label> <input value-for="officer" class="form-control" value="">
</div></div></form>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (o:Officer)
WHERE o.name CONTAINS '<span  value-key="officer"></span>'
RETURN o
LIMIT 100</code></pre>
</div>
</div>

<div class="paragraph">
<p>After running the query, you can double-click on any node to expand connections in the graph to that node.
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Search for an Officer and find the connections</h3>
    <br/>
    <div class="paragraph">
<p>Let’s see with which entities an officer was involved with, including first and second degree connections.</p>
</div>
<form><div class="node"><div class="form-group">
<label>Name of officer:</label> <input value-for="officer" class="form-control" value="">
</div></div></form>
<div class="listingblock">
<div class="title">1st degree</div>
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (o:Officer)
WHERE o.name CONTAINS '<span  value-key="officer"></span>'
MATCH path = (o)-[r]->(:Entity)
RETURN path LIMIT 100</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">2nd degree entities</div>
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (o:Officer) WHERE o.name CONTAINS '<span  value-key="officer"></span>'
MATCH path = (o)-[]->(:Entity)
      <-[]-(:Officer)-[]->(:Entity)
RETURN path LIMIT 100</code></pre>
</div>
</div>
  </div>


</slide>

<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Find who is behind an Entity and the roles that they play</h3>
    <br/>
    <div>
      
<form><div class="node"><div class="form-group">
<label>Name of entity:</label> <input value-for="entity" class="form-control" value="">
</div></div></form>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (e:Entity)-[r]-(o:Officer)
WHERE e.name CONTAINS '<span  value-key="entity"></span>'
RETURN *
LIMIT 200</code></pre>
</div>
</div>
  </div>
  </div>
</slide>


<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Joint involvement</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>When investigating, it is very important to identify people that appear to operate together. You can try to find if two officers appear connected to the same entities recurrently by using this query. Note that in this case, the first results show companies because companies can also be officers of entities.</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (o1:Officer)-[r1]-&gt;(e:Entity)&lt;-[r2]-(o2:Officer)
WHERE id(o1) &lt; id(o2)
AND size( (o1)--&gt;() ) &gt; 2 AND size( (o2)--&gt;() ) &gt; 2
WITH o1,o2,count(*) as freq, collect(e.name)[0..10] as entities
WHERE freq &gt; 2
RETURN o1.name, o2.name, freq, entities
ORDER BY freq DESC
LIMIT 10</code></pre>
</div>
</div>

<div class="paragraph">
<p>We can attempt to remove companies from the results by filtering our Officer names that contain strings commonly found in company names such as "LLC", "Limited", "Ltd", etc:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (o1:Officer)-[r1]-&gt;(e:Entity)&lt;-[r2]-(o2:Officer)
WHERE id(o1) &lt; id(o2) AND NOT o1.name CONTAINS "LIMITED" AND NOT o1.name CONTAINS "Limited"
AND NOT o2.name CONTAINS "Limited" AND NOT o2.name CONTAINS "LIMITED"
AND size( (o1)--&gt;() ) &gt; 2 AND size( (o2)--&gt;() ) &gt; 2
WITH o1,o2,count(*) as freq, collect(e.name)[0..10] as entities
WHERE freq &gt; 2
RETURN o1.name, o2.name, freq, entities
ORDER BY freq DESC
LIMIT 10</code></pre>
</div>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Shortest path between two people</h3>
    <br/>
    <div>
      <form><div class="node"><div class="form-group">
<label>Name of the first officer:</label> <input value-for="officerOne" value="Smith" class="form-control">
<label>Name of the second officer:</label> <input value-for="officerTwo" value="Grant" class="form-control">
</div></div></form>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (a:Officer),(b:Officer)
WHERE a.name CONTAINS '<span  value-key="officerOne">Smith</span>' AND b.name CONTAINS '<span  value-key="officerTwo">Grant</span>'
WITH a,b LIMIT 20000
MATCH p=allShortestPaths((a)-[:OFFICER_OF|:INTERMEDIARY_OF|:REGISTERED_ADDRESS*..10]-(b))
RETURN p
LIMIT 50</code></pre>
</div>
</div>
	</div>
  </div>
</slide>

<!-- LOCATION QUERIES -->

<!-- ADDRESS QUERY -->
<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Query by address</h3>
    <br/>
    <div>
      <div class="paragraph">
        <p>We can use Neo4j's string comparison functions to search for addresses that contain cities and countries in which we are interested: </p>
      </div>
      <form><div class="node"><div class="form-group">
<label>City: </label> <input value-for="city" value="Barcelona" class="form-control">
<label>State/Country: </label> <input value-for="state" value="Spain" class="form-control">
</div></div></form>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (a:Address)<-[:REGISTERED_ADDRESS]-(other)
WHERE a.address CONTAINS '<span  value-key="city">Barcelona</span>' AND a.address CONTAINS '<span  value-key="state">Spain</span>'
RETURN a, other
LIMIT 100</code></pre>
</div>
</div>
  </div>
  </div>
</slide>

<!-- OFFSHORE ENTITY JURISDICTIONS BY INTERMEDIARY QUERY -->
<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Offshore entity juridictions by intermediary</h3>
    <br/>
    <div>
      <div class="paragraph">
        <p>What are the most popular offshore jurisdictions for certain intermediaries?</p>
      </div>
      <form><div class="node"><div class="form-group">
<label>Name of the intermediary:</label> <input value-for="intermediary" value="MOSSACK" class="form-control">
</div></div></form>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (i:Intermediary)-[:INTERMEDIARY_OF]->(e:Entity)
WHERE i.name CONTAINS '<span value-key="intermediary">MOSSACK</span>'
RETURN e.jurisdiction_description AS jurisdiction, count(*) AS number
ORDER BY number DESC LIMIT 10</code></pre>
</div>
</div>
  </div>
  </div>
</slide>



<!-- MOST POPULAR OFFSHORE JURISDICTIONS FOR PEOPLE CONNECTED TO THE US -->
<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Most popular offshore jurisdiction for people connected to a country</h3>
    <br/>
    <div>
      <div class="paragraph">
        <p>What are the common offshore jurisdictions for officers with addresses in a certain country?</p>
      </div>
      <form><div class="node"><div class="form-group">
<label>Country code:</label> <input value-for="countryCode" value="USA" class="form-control">
</div></div></form>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (o:Officer)-->(e:Entity)<-[:INTERMEDIARY_OF]-(i:Intermediary)
WHERE o.country_codes CONTAINS '<span  value-key="countryCode">USA</span>'
RETURN e.jurisdiction_description AS jurisdiction, count(*) AS number
ORDER BY number DESC LIMIT 10</code></pre>
</div>
</div>
  </div>
  </div>
</slide>


<!-- MOST POPULAR OFFSHORE JURISDICTIONS FOR PEOPLE WITH ADDRESSES IN ____ CITY -->
<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Most popular offshore jurisdictions for people with addresses in a certain city</h3>
    <br/>
    <div>
      <div class="paragraph">
        <p>What are the common offshore jurisdictions used by people connected to certain cities?</p>
      </div>
      <form><div class="node"><div class="form-group">
<label>City:</label> <input value-for="state" value="Barcelona" class="form-control">
<label>State/country:</label> <input value-for="state" value="Spain" class="form-control">
</div></div></form>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (a:Address)<-[:REGISTERED_ADDRESS]-(o:Officer),
(o)-->(e:Entity)<-[:INTERMEDIARY_OF]-(i:Intermediary)
WHERE a.address CONTAINS '<span valeue-key="city">Barcelona</span>' AND a.address CONTAINS '<span value-key="state">Spain</span>'
RETURN e.jurisdiction_description AS jurisdiction, count(*) AS number 
ORDER BY number DESC LIMIT 10</code></pre>
</div>
</div>
  </div>
  </div>
</slide>


<!-- MOST POPULAR INTERMEDIARIES FOR PEOPLE WITH AN ADDRESS IN ____ CITY -->
<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Most popular intermediaries for people with an address in a certain city?</h3>
    <br/>
    <div>
      <div class="paragraph">
        <p>Who are the most common intermediaries for officers connected to addresses in certain cities?</p>
      </div>
      <form><div class="node"><div class="form-group">
        <label>City:</label> <input value-for="state" value="Barcelona" class="form-control">
        <label>State/country:</label> <input value-for="state" value="Spain" class="form-control">
      </div></div></form>
      <div class="listingblock">
        <div class="content">
          <pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (a:Address)<-[:REGISTERED_ADDRESS]-(o:Officer),
(o)-->(e:Entity)<-[:INTERMEDIARY_OF]-(i:Intermediary)
WHERE a.address CONTAINS '<span valeue-key="city">Barcelona</span>' AND a.address CONTAINS '<span value-key="state">Spain</span>'
RETURN i.name AS intermediary, count(DISTINCT e) AS number 
ORDER BY number DESC LIMIT 10</code></pre>
        </div>
      </div>
    </div>
  </div>
</slide>



<!-- END LOCATION QUERIES -->



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Full Text Search</h3>
    <br/>
    <div>
      <div class="paragraph">
        <p>All the previous queries we run were searching the exact text of a node. However, you can also build an index to search the text of properties inside a node. Just like in a book where you look at the index to find a section that interest you, and then start reading from there.</p>

        <p>For that, you need to build the index first. It will take a little while since the procedure has to read through the entire database to create it.</p>
      </div>

      <div class="paragraph">
        <p><em>We used Solr as a full text search engine to search across all data.
But you can do the same in Neo4j directly, both use Apache Lucene under the hood for full text search.</em></p>
      </div>

      <div class="paragraph">
      <p>In order to use the full text search feature, we have to first index our data by specifying all the properties we want to index.
Here we create a full text index called <code>offshore</code> (we will use this name when searching in the index) with our data.</p>
      </div>

<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">CALL apoc.index.addAllNodes('offshore',{
  Officer: ["name","countries"],
  Intermediary:  ["name","address","countries"],
  Address: ["address","countries"],
  Entity: ["name", "address", "service_provider", "former_name", "company_type","countries"]})</code></pre>
</div>
</div>
<div class="paragraph">
  <p>We can now use this index to search for any text contained in the properties. As a result of the query you'll get the nodes with matching text.</p>
</div>

<div class="paragraph">
  <p>The most simple case would be to search across all data for an exact match of a particular word.</p>
</div>

<div class="paragraph">
  <p>If you enter a word into the form, all occurrences will be found (but limited to 100 results).</p>
</div>

<form><div class="node"><div class="form-group">
<label>Word to search for:</label> <input value-for="search" class="form-control">
</div></div></form>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">CALL apoc.index.search("offshore", '<span  value-key="search"></span>')</code></pre>
</div>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Full text search - advanced</h3>
    <br/>
    <div>
      <div class="paragraph">
      <p>You can futher restrict the full text search to only searching in a particular property. In order to seach for an <code>Entity</code> incorporated by offshore service provider <em>Mossack Fonseca</em>, use the following: </p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">CALL apoc.index.search("offshore", "Entity.service_provider:Mossack Fonseca")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test it yourself:</p>
</div>
<form><div class="node"><div class="form-group">
<label>Label/Type to search for:</label> <input value-for="label" value="Entity" class="form-control">
<label>Attribute to search for:</label> <input value-for="property" value="service_provider" class="form-control">
<label>Word to search for:</label> <input value-for="search" value="Mossack Fonseca" class="form-control">
</div></div></form>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">CALL apoc.index.search("offshore", "<span  value-key="label">Entity</span>.<span  value-key="property">service-provider</span>:<span value-key="search">Mossack Fonseca</span>")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can search for nodes with a specific property value, and then explore their neighbourhoods visually by double-clicking to expand relationships.</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Full text search with graph patterns</h3>
    <br/>
    <div>
      <div class="paragraph">
        <p>Previously we searched for nodes by matching against property values. However, integrating text search with an graph query is so much more powerful.</p>
        <p>We could for instance search for addresses in the database that contain the word "Barcelona", and then find all entities registered at those addresses:</p>
      </div>

<div class="listingblock">
  <div class="content">
    <pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">CALL apoc.index.search("offshore", "Address.address:Barcelona")
YIELD node AS addr
MATCH (addr)&lt;-[:REGISTERED_ADDRESS]-(entity)
RETURN entity LIMIT 50</code></pre>
  </div>
</div>





<div class="paragraph">
  <p>There may be typos in the data so we can use fuzzy matching to find addresses that have inconsistent spellings.</p>
  <p>Add a tilde (~) to instruct the index search procedure to do a fuzzy match, allowing you to find “Barcelona” even if the spelling is slightly off.</p>
</div>

<div class="listingblock">
  <div class="content">
    <pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">CALL apoc.index.search("offshore", "Address.address:Barcelona~")
YIELD node AS addr
MATCH (addr)&lt;-[:REGISTERED_ADDRESS]-(entity)
RETURN entity LIMIT 50</code></pre>
  </div>
</div>


<div class="paragraph">
  <p>You might notice that there are addresses that contain the word “Barcelona” that are not in Barcelona, Spain.</p>

  <p>We can further specify that we want the text to contain both the word Barcelona, and the word Spain:</p>
</div>

<div class="listingblock">
  <div class="content">
    <pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">CALL apoc.index.search("offshore", "+Address.address:Barcelona~ +Spain~")
YIELD node AS addr
MATCH (addr)&lt;-[:REGISTERED_ADDRESS]-(entity)
RETURN entity LIMIT 50</code></pre>
  </div>
</div>

<div class="paragraph">
<p>For more details on the query syntax used in the second parameter of the <code>search</code> procedure, please see <a href="https://www.lucenetutorial.com/lucene-query-syntax.html">this Lucene query tutorial</a></p>
</div>
	
</div>
</div>
</slide>


<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Graph Analytics</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>PageRank is an algorithm used for instance by Google to rank websites in their search engine results.
It assumes that more important entities are likely to have more connections pointing to them, and not just directly but also indirectly.</p>
</div>
<div class="paragraph">
<p>The algorithm can also be used as way of measuring the importance of entities in a network.
Let’s use PageRank to find the top 20 ranked entities in the dataset.</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (i:Intermediary)
WITH collect(i) AS intermediaries
CALL apoc.algo.pageRank(intermediaries) YIELD node, score
RETURN node.name AS entity, score
ORDER BY score DESC
LIMIT 20</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s try a similar query but investigating different patterns.
The following detects the 10 top ranked addresses.
It then finds how many entities are registered at those addresses. Note that the address nodes contain text that has not been standardized, therefore there may be inconsistencies in the address data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable code runnable standalone-example ng-binding"><code class="cypher language-cypher">MATCH (a:Address)
WITH collect(a) AS addresses
CALL apoc.algo.pageRank(addresses) YIELD node as address, score
WITH * ORDER BY score DESC  LIMIT 10
MATCH (address)&lt;-[:REGISTERED_ADDRESS]-(e:Entity)
RETURN address.address, count(e) AS count
ORDER BY count DESC</code></pre>
</div>
</div>
	</div>
  </div>
</slide>


<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Conclusion</h3>
    <br/>
    <div>
      <div class="paragraph">
        <p></p>
      </div>

      <div class="paragraph">
        <p></p>
      </div>

<div class="paragraph">
  <p>Our work would not be possible without our donors, we&#8217;re grateful for <a href="https://donate.icij.org/">any donation</a> that enables us to continue further independent research and investigation.</p>
</div>

<div class="paragraph">
<p>Follow these links, if you want to learn more about</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <a href="https://panamapapers.icij.org/">Panama Paper stories</a></p>
</li>
<li>
<p>our <a href="https://youtu.be/S20XMQyvANY?list=PL9Hl4pk2FsvWROJKLzm7LMw1AhYg_Kf_i">technical work</a></p>
</li>
<li>
<p>the <a href="https://neo4j.com/developer">Neo4j graph database</a></p>
</li>
<li>
<p>the "apoc" collection of <a href="https://github.com/neo4j-contrib/neo4j-apoc-procedures#included-procedures-overview">useful procedures for Neo4j</a></p>
</li>
</ul>
</div>
	</div>
  </div>
</slide>
  </carousel>


  <footer class="panama">
    <ul class="list-inline">
      <li><a click-to-code="':play https://cloudfront-files-1.publicintegrity.org/offshoreleaks/neo4j/guide/'" class="sl sl-house">

          Introduction</a></li>
      <li><a click-to-cdoe="':play https://cloudfront-files-1.publicintegrity.org/offshoreleaks/neo4j/guide/examples.html'" class="sl sl-show">

          Investigative queries</a></li>
      <li><a click-to-code="':play https://cloudfront-files-1.publicintegrity.org/offshoreleaks/neo4j/guide/datashape.html'" class="sl sl-network-trio">

          Shape of the data</a></li>
    </ul>
    <ul class="list-inline list-right">
      <li><a href="https://panamapapers.icij.org/" tooltip="Read about it."> <img src="https://panamapapers.icij.org/assets/Logo_bg@2x.png" width="auto" height="28px" class="icij"/></a></li>
      <li><a target="_blank" href="https://twitter.com/intent/tweet?original_referer=https%3A%2F%2Foffshoreleaks.icij.org%2F&amp;ref_src=twsrc%5Etfw&amp;text=Look%20what%20I%20have%20found%20in%20the%20%23PanamaPapers%20%40Neo4j%20graph%20database%20release%3A&amp;tw_p=tweetbutton&amp;url=https%3A%2F%2Foffshoreleaks.icij.org%2F" tooltip="Tweet about it." class="fa fa-twitter-square"></a></li>
    </ul>
  </footer>
</article>
